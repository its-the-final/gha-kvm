defaults:
  run:
    shell: bash
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image:
        default: "https://dl-cdn.alpinelinux.org/alpine/v3.22/releases/cloud/nocloud_alpine-3.22.1-x86_64-bios-cloudinit-r0.qcow2"
        description: "Image to load "
      size:
        default: "24G"
        description: "resize img" 
      preloader:
        default: "none"
        description: "pre-hook"
      loader:
        default: "none"
        description: "inside-hook"
      keymap:
        default: "en-us"
        description: "keymap"
      cdrom:
        default: "none"
        description: "cd image"
      sshkey:
        default: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAEAQC6cZ/ZGVD547VMy4Cz/sMVAezZsv33woT8v9zCh0WuSIcMZOFIeBhI7oB6L7hwSlGmb2BNFmgJJ5ML0jy6y55rI1X0EaQV9uLTdYcfpcFUu0sbq5/9TAEWqt5EL8R7nxs7Yl8FEfUhG4GAMiDUwJK9oOIHvtzjqdCNYZKOB5JyVc3/tBqtUXbMrGP+ZLuqscxLrdbgQRg6FTOXt8jW48ofYa7nM7tMoFBXIN7wSCPpifme7HnoblHIeoPlGwyLPEiu36pnj6KAKQCZgYenx8Noj99+nnFJorxbtgIL7WMWjt+HlVaiVEZ6A6MbaZbwrhpCiow57bd3zdq3vluZwPZNNCL8AOKXtm7D35aC+wKibur7FyundFNlKpHgTtXRYNEKRj/ulW1z2HKwoU6Ban6X+rSzVmGkBiQyB/G76L8b/eXRh3Hptvbp4nQu15kGhsQXZA7g7Z25yPlmeO7pWMRJRNbohhOM/29PX1c6dH9+WoNJtkHh6Hk1fgTD0JDVxNFarIjmxv0nIQUcr0tdsL2/3o0t7sZwjtZvoFSGqKsZ5PMAqUHjJiDnGwK+GDBOoWWtrtkJXNfSxwl0Zsazj6tN4CG29sUjzss9LWcNTa8zdUhb3RY6OhpWcQaBJi/MmQVKLacwy+KxKfhMEXmNkaVWyX3eCaK1ih9q7wWM6iDWX1pJkmKlroXmRzVaSgfNb1JIRkBtiecOHN+26Bv59TbJcKkYXsbBP6P4m5VqjiJD2xw/VN6sW8Kohu9igBtxNR4ayYqKyIRPE5UbE/kl4x+84C//IfKdnRoLmCwkUauOC8z/5ThMmlASAtIOgAcdQSJRXWyWtQoZnDc5Om3SCejqflkBceQpr8JeqRN9jHDGAXCQrQjm4AUnwHnJU9O3O8CFjhUuSqVrqY3myJPN1g0T8INvF5KYzUk9Zhgp18vYeY8/TqpJbcGT3aXeIFa87LXEPk7SruPjbtUjvmqlXp8ADLXIwE6vVpLveutto1RCtp72XKc1poL7nS5BmLW5efeqJqApNx/o32sTh9ZtRpMj5+GZDr8ZPGEG5hX6ZtMqee3NtANpTgm4ocAO0kYl+kwnWJtP/Z/QceCd5NLKzzLVohNE+KlDsTTz7u0TsazOsaPPYZ2P+tO5nuFkTwA/E4aXHhc4PvyOOnREDdN24ij3owEE/tv+37i+ZWdSdTDnQMV7XzgsbmtsQbYNp2EAaiQvbDHCYmpABXRzkdwsYhIsHy535s9xed890gtcwrecqHOaUt09THpReh8i6pphVTqEcVCb+VdkoLzekbMFRhYIOlykpVpXF8rcx5owrET91UjGsoQ2ZxTwvJRTgnmOwjzGsZNxAcW2EIhPtysfhMLR mykey@host"
        description: "sshkey" 

jobs:
  setup:
    runs-on: ubuntu-latest
    container: ghcr.io/its-the-final/gha-kvm:latest
    steps:
      - uses: actions/checkout@v4
#      - uses: ilammy/setup-nasm@v1
      - name: Set default value
        id: valuesprep
        run: |
          KEY_INPUT=${{ github.event.inputs.sshkey }}
          echo sshkey=${IMG_INPUT:-"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAEAQC6cZ/ZGVD547VMy4Cz/sMVAezZsv33woT8v9zCh0WuSIcMZOFIeBhI7oB6L7hwSlGmb2BNFmgJJ5ML0jy6y55rI1X0EaQV9uLTdYcfpcFUu0sbq5/9TAEWqt5EL8R7nxs7Yl8FEfUhG4GAMiDUwJK9oOIHvtzjqdCNYZKOB5JyVc3/tBqtUXbMrGP+ZLuqscxLrdbgQRg6FTOXt8jW48ofYa7nM7tMoFBXIN7wSCPpifme7HnoblHIeoPlGwyLPEiu36pnj6KAKQCZgYenx8Noj99+nnFJorxbtgIL7WMWjt+HlVaiVEZ6A6MbaZbwrhpCiow57bd3zdq3vluZwPZNNCL8AOKXtm7D35aC+wKibur7FyundFNlKpHgTtXRYNEKRj/ulW1z2HKwoU6Ban6X+rSzVmGkBiQyB/G76L8b/eXRh3Hptvbp4nQu15kGhsQXZA7g7Z25yPlmeO7pWMRJRNbohhOM/29PX1c6dH9+WoNJtkHh6Hk1fgTD0JDVxNFarIjmxv0nIQUcr0tdsL2/3o0t7sZwjtZvoFSGqKsZ5PMAqUHjJiDnGwK+GDBOoWWtrtkJXNfSxwl0Zsazj6tN4CG29sUjzss9LWcNTa8zdUhb3RY6OhpWcQaBJi/MmQVKLacwy+KxKfhMEXmNkaVWyX3eCaK1ih9q7wWM6iDWX1pJkmKlroXmRzVaSgfNb1JIRkBtiecOHN+26Bv59TbJcKkYXsbBP6P4m5VqjiJD2xw/VN6sW8Kohu9igBtxNR4ayYqKyIRPE5UbE/kl4x+84C//IfKdnRoLmCwkUauOC8z/5ThMmlASAtIOgAcdQSJRXWyWtQoZnDc5Om3SCejqflkBceQpr8JeqRN9jHDGAXCQrQjm4AUnwHnJU9O3O8CFjhUuSqVrqY3myJPN1g0T8INvF5KYzUk9Zhgp18vYeY8/TqpJbcGT3aXeIFa87LXEPk7SruPjbtUjvmqlXp8ADLXIwE6vVpLveutto1RCtp72XKc1poL7nS5BmLW5efeqJqApNx/o32sTh9ZtRpMj5+GZDr8ZPGEG5hX6ZtMqee3NtANpTgm4ocAO0kYl+kwnWJtP/Z/QceCd5NLKzzLVohNE+KlDsTTz7u0TsazOsaPPYZ2P+tO5nuFkTwA/E4aXHhc4PvyOOnREDdN24ij3owEE/tv+37i+ZWdSdTDnQMV7XzgsbmtsQbYNp2EAaiQvbDHCYmpABXRzkdwsYhIsHy535s9xed890gtcwrecqHOaUt09THpReh8i6pphVTqEcVCb+VdkoLzekbMFRhYIOlykpVpXF8rcx5owrET91UjGsoQ2ZxTwvJRTgnmOwjzGsZNxAcW2EIhPtysfhMLR mykey@host"} >> "$GITHUB_OUTPUT"
          IMG_INPUT=${{ github.event.inputs.image }}
          MYIMG=${IMG_INPUT:-"https://dl-cdn.alpinelinux.org/alpine/v3.22/releases/cloud/nocloud_alpine-3.22.1-x86_64-bios-cloudinit-r0.qcow2"}
          echo "image=${IMG_INPUT:-"https://dl-cdn.alpinelinux.org/alpine/v3.22/releases/cloud/nocloud_alpine-3.22.1-x86_64-bios-cloudinit-r0.qcow2"}" >> "$GITHUB_OUTPUT"
          echo imgsum=$(echo ${IMG_INPUT:-"https://dl-cdn.alpinelinux.org/alpine/v3.22/releases/cloud/nocloud_alpine-3.22.1-x86_64-bios-cloudinit-r0.qcow2"} |md5sum|cut -d" " -f1) >> "$GITHUB_OUTPUT"
          PRELOADR_INPUT=${{ github.event.inputs.loader }}
          echo "preloader=${PRELOADR_INPUT:-"none"}" >> "$GITHUB_OUTPUT"
          LOADR_INPUT=${{ github.event.inputs.loader }}
          echo "loader=${LOADR_INPUT:-"none"}" >> "$GITHUB_OUTPUT"
          SIZE_INPUT=${{ github.event.inputs.size }}
          echo "size=${SIZE_INPUT:-"24G"}" >> "$GITHUB_OUTPUT"
          DEFKEY=${{ github.event.inputs.keymap }}
          echo "keymap=${DEFKEY:-"en-us"}" >> "$GITHUB_OUTPUT"
          DEF_VGAMB=${{ github.event.inputs.vgamem }}
          echo "vgamem=${DEF_VGAMB:-"128"}" >> "$GITHUB_OUTPUT"
          DEF_CD=${{ github.event.inputs.vgamem }}
          MYCD=${DEF_CD:-"none"}
          BOOTDEF=cd
          echo "${MYCD}"  | grep ^none$ || BOOTDEF=dc
          echo "bootorder=$BOOTDEF"   >> "$GITHUB_OUTPUT"
          echo "bootorder=$BOOTDEF"
          echo "${MYCD}"  | grep ^none$ || wget -O cdrom/cd.iso -c "${MYCD}"
          echo "${MYCD}"  | grep ^none$ || echo cdrom="file=cdrom/cd.iso,if=ide,index=1,media=cdrom" >> "$GITHUB_OUTPUT"
          echo "${MYCD}"  | grep ^none$ && echo cdrom="if=ide,index=1,media=cdrom" >> "$GITHUB_OUTPUT"
          git config --global --add safe.directory $(pwd)
          echo sha_short=$(git log --pretty=format:'%H' -n 1) >> "$GITHUB_OUTPUT"
          echo sha_short=$(git log --pretty=format:'%H' -n 1)
      - name: Cache Primes
        id: cache-primes
        uses: actions/cache@v4
        with:
          path: alpine-x86_64.qcow2
          key: ${{ runner.os }}-primes-${{ steps.valuesprep.outputs.imgsum }}
  
      - name: Prepare Boot-Man demo
        if: steps.cache-primes.outputs.cache-hit != 'true'
        run: |
          #git clone https://github.com/guyhill/Boot-Man
          #cd Boot-Man
          #make
          #sudo rm -rf /var/cache/apt/archives; mkdir aptcache_archives;sudo ln -s $(pwd)/aptcache_archives /var/cache/apt/archives 
          sudo chmod -R a+r /var/cache/apt/archives
          which qemu-img || sudo apt-get update && ( time (sudo apt-get -y install qemu-utils netcat-openbsd cloud-image-utils 2>&1 |wc -l ))
          bash -c "mkdir images;cd images ;time wget -q -c -O machine.qcow2 ${{ steps.valuesprep.outputs.image }}"
          #wget -q -c https://cloud.debian.org/images/cloud/bullseye-backports/20250703-2162/debian-11-backports-nocloud-amd64-20250703-2162.tar.xz
          #tar --xz -xf debian-11-backports-nocloud-amd64-20250703-2162.tar.xz
          #ln -s debian-11-backports-nocloud-amd64-20250703-2162.raw alpine-x86_64.img
          bash -c "time  qemu-img resize images/machine.qcow2 +${{ steps.valuesprep.outputs.size }}" || true
          test -e qemu-kvm-action || git clone https://github.com/incredinews/qemu-kvm-action.git
#          test -e qemu-kvm-action || git clone https://github.com/etchdroid/qemu-kvm-action.git
########      - name: cachetar
########        id: cachetar
########        run: |
########          tar cvzf /tmp/cache.tgz .
########          mv /tmp/cache.tgz .
########          pwd
########      - name: Upload math result for job 1
########        uses: actions/upload-artifact@v4
########        with:
########          name: ${{ runner.os }}-step-${{ github.run_id }}
########          path: cache.tgz
########          retention-days: 1
      - name: Save Primes
        id: cache-primes-save
        uses: actions/cache/save@v4
        with:
#          path: alpine-x86_64.qcow2
          path: |
            images
            cdrom
#            /var/cache/apt/archives
          key: ${{ runner.os }}-primes-${{ steps.valuesprep.outputs.imgsum }}
#          key: ${{ steps.cache-primes-restore.outputs.cache-primary-key }}


#########  run:
#########    runs-on: ubuntu-latest
#########    #container: ghcr.io/its-the-final/gha-kvm:latest
#########    needs: setup
#########    steps:
#########      - uses: actions/checkout@v4
#########      - name: Set default value
#########        id: valuesprep
#########        run: |
#########          KEY_INPUT=${{ github.event.inputs.sshkey }}
#########          echo sshkey=${KEY_INPUT:-"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAEAQC6cZ/ZGVD547VMy4Cz/sMVAezZsv33woT8v9zCh0WuSIcMZOFIeBhI7oB6L7hwSlGmb2BNFmgJJ5ML0jy6y55rI1X0EaQV9uLTdYcfpcFUu0sbq5/9TAEWqt5EL8R7nxs7Yl8FEfUhG4GAMiDUwJK9oOIHvtzjqdCNYZKOB5JyVc3/tBqtUXbMrGP+ZLuqscxLrdbgQRg6FTOXt8jW48ofYa7nM7tMoFBXIN7wSCPpifme7HnoblHIeoPlGwyLPEiu36pnj6KAKQCZgYenx8Noj99+nnFJorxbtgIL7WMWjt+HlVaiVEZ6A6MbaZbwrhpCiow57bd3zdq3vluZwPZNNCL8AOKXtm7D35aC+wKibur7FyundFNlKpHgTtXRYNEKRj/ulW1z2HKwoU6Ban6X+rSzVmGkBiQyB/G76L8b/eXRh3Hptvbp4nQu15kGhsQXZA7g7Z25yPlmeO7pWMRJRNbohhOM/29PX1c6dH9+WoNJtkHh6Hk1fgTD0JDVxNFarIjmxv0nIQUcr0tdsL2/3o0t7sZwjtZvoFSGqKsZ5PMAqUHjJiDnGwK+GDBOoWWtrtkJXNfSxwl0Zsazj6tN4CG29sUjzss9LWcNTa8zdUhb3RY6OhpWcQaBJi/MmQVKLacwy+KxKfhMEXmNkaVWyX3eCaK1ih9q7wWM6iDWX1pJkmKlroXmRzVaSgfNb1JIRkBtiecOHN+26Bv59TbJcKkYXsbBP6P4m5VqjiJD2xw/VN6sW8Kohu9igBtxNR4ayYqKyIRPE5UbE/kl4x+84C//IfKdnRoLmCwkUauOC8z/5ThMmlASAtIOgAcdQSJRXWyWtQoZnDc5Om3SCejqflkBceQpr8JeqRN9jHDGAXCQrQjm4AUnwHnJU9O3O8CFjhUuSqVrqY3myJPN1g0T8INvF5KYzUk9Zhgp18vYeY8/TqpJbcGT3aXeIFa87LXEPk7SruPjbtUjvmqlXp8ADLXIwE6vVpLveutto1RCtp72XKc1poL7nS5BmLW5efeqJqApNx/o32sTh9ZtRpMj5+GZDr8ZPGEG5hX6ZtMqee3NtANpTgm4ocAO0kYl+kwnWJtP/Z/QceCd5NLKzzLVohNE+KlDsTTz7u0TsazOsaPPYZ2P+tO5nuFkTwA/E4aXHhc4PvyOOnREDdN24ij3owEE/tv+37i+ZWdSdTDnQMV7XzgsbmtsQbYNp2EAaiQvbDHCYmpABXRzkdwsYhIsHy535s9xed890gtcwrecqHOaUt09THpReh8i6pphVTqEcVCb+VdkoLzekbMFRhYIOlykpVpXF8rcx5owrET91UjGsoQ2ZxTwvJRTgnmOwjzGsZNxAcW2EIhPtysfhMLR mykey@host"} >> "$GITHUB_OUTPUT"
#########          IMG_INPUT=${{ github.event.inputs.image }}
#########          MYIMG=${IMG_INPUT:-"https://dl-cdn.alpinelinux.org/alpine/v3.22/releases/cloud/nocloud_alpine-3.22.1-x86_64-bios-cloudinit-r0.qcow2"}
#########          echo "image=${IMG_INPUT:-"https://dl-cdn.alpinelinux.org/alpine/v3.22/releases/cloud/nocloud_alpine-3.22.1-x86_64-bios-cloudinit-r0.qcow2"}" >> "$GITHUB_OUTPUT"
#########          echo imgsum=$(echo ${IMG_INPUT:-"https://dl-cdn.alpinelinux.org/alpine/v3.22/releases/cloud/nocloud_alpine-3.22.1-x86_64-bios-cloudinit-r0.qcow2"} |md5sum|cut -d" " -f1) >> "$GITHUB_OUTPUT"
#########          PRELOADR_INPUT=${{ github.event.inputs.loader }}
#########          echo "preloader=${PRELOADR_INPUT:-"none"}" >> "$GITHUB_OUTPUT"
#########          LOADR_INPUT=${{ github.event.inputs.loader }}
#########          echo "loader=${LOADR_INPUT:-"none"}" >> "$GITHUB_OUTPUT"
#########          SIZE_INPUT=${{ github.event.inputs.size }}
#########          echo "size=${SIZE_INPUT:-"24G"}" >> "$GITHUB_OUTPUT"
#########          DEFKEY=${{ github.event.inputs.keymap }}
#########          echo "keymap=${DEFKEY:-"en-us"}" >> "$GITHUB_OUTPUT"
#########          DEF_CD=${{ github.event.inputs.cdrom }}
#########          MYCD=${DEF_CD:-"none"}
#########          echo "${MYCD}"  | grep ^none$ || wget -O cdrom/cd.iso -c "${MYCD}"
#########          echo "${MYCD}"  | grep ^none$ || echo cdrom="file=cdrom/cd.iso,if=ide,index=1,media=cdrom" >> "$GITHUB_OUTPUT"
#########          echo "${MYCD}"  | grep ^none$ && echo cdrom="if=ide,index=1,media=cdrom" >> "$GITHUB_OUTPUT"
#########          echo "${MYCD}"  | grep ^none$ && echo "boot=cd" >> "$GITHUB_OUTPUT"
#########          echo "${MYCD}"  | grep ^none$ || echo "boot=dc" >> "$GITHUB_OUTPUT"
#########          git config --global --add safe.directory $(pwd)
#########          echo sha_short=$(git log --pretty=format:'%H' -n 1) >> "$GITHUB_OUTPUT"
#########          echo sha_short=$(git log --pretty=format:'%H' -n 1)
#########          echo;ipconfig="myip="$(ip a|grep eth0|grep inet|grep -v inet6|cut -dt -f2|cut -d/ -f1|head -n1|cut -d" " -f2);echo $ipconfig;echo $ipconfig >> $GITHUB_OUTPUT
#########
#########      - name: Download result for job 2
#########        uses: actions/download-artifact@v4
#########        with:
#########            name: ${{ runner.os }}-step-${{ github.run_id }}
#########      - name: Del result for job 2
#########        uses: geekyeggo/delete-artifact@v5
#########        with:
#########            name: ${{ runner.os }}-step-${{ github.run_id }}
#########      - name: cachetar
#########        id: cachetar
#########        run: |
#########          tar xvzf cache.tgz 



      - name: PREPARE qemu
        id: prepareqemu
        run: |
             sed 's~SSHKEY~${{ steps.valuesprep.outputs.sshkey }}~g' setupscript -i || true
             ( [[ -z "${{ steps.valuesprep.outputs.myip }}" ]] || echo "${{ steps.valuesprep.outputs.myip }}" > /tmp/myip ) || true 
             bash prepare-cloudinit.sh; 
             NEEDPKG=""
             
             which nc|| NEEDPKG="$NEEDPKG netcat-openbsd"
             which ip|| NEEDPKG="$NEEDPKG iproute2"
             which manpath|| NEEDPKG="$NEEDPKG man-db"
             which cloud-localds  || NEEDPKG="$NEEDPKG cloud-image-utils"
             for needbin in curl python3 ;do which "$needbin" || NEEDPKG="$needbin $NEEDPKG";done
             #dpkg --get-selections|grep -v deinstall$|grep -q ^qemu-kvm|| NEEDPKG="$NEEDPKG qemu-kvm"
             echo "NEED: $NEEDPKG"
             [[ -z "$NEEDPKG" ]] || (   echo "apt_inst .. upd:" ; sudo apt-get update |wc -l  ; echo -n inst:; sudo apt-get install "$NEEDPKG" 2>&1 > /tmp/installres|| (sleep 0.4;cat /tmp/installres || true );( cat /tmp/installres 	|wc -l )||true ) 
             #which cloud-localds  || (sudo apt-get update;sudo apt-get install --no-install-recommends --yes iproute2 netcat-openbsd cloud-image-utils );
             test -e seed.img && rm seed.img ; echo gen seed;
             cloud-localds seed.img cinit/user-data cinit/meta-data ; 
             #which python3 || (sudo apt-get update;sudo apt-get -y --no-install-recommends python3)  ;
             cd cinit;pwd;python3 -m http.server --directory . &  sleep 2;curl 127.0.0.1:8000;
             echo;echo;ipconfig="myip="$(ip a|grep eth0|grep inet|grep -v inet6|cut -dt -f2|cut -d/ -f1|head -n1|cut -d" " -f2);echo $ipconfig;echo $ipconfig >> $GITHUB_OUTPUT
      - name: Set root disk and run preloader scripts
        id: setroot
        run: |
             IMG_INPUT=${{ github.event.inputs.image }}
             MYIMG=${IMG_INPUT:-"https://dl-cdn.alpinelinux.org/alpine/v3.22/releases/cloud/nocloud_alpine-3.22.1-x86_64-bios-cloudinit-r0.qcow2"}
             echo "${MYIMG}" | grep -q ^s3b: || echo root="images/machine.qcow2" >> "$GITHUB_OUTPUT"
             echo "${MYIMG}" | grep -q ^s3b: && echo root="nbd://${{ steps.valuesprep.outputs.myip }}:1111/qemu"  >> "$GITHUB_OUTPUT"
             echo "${MYIMG}" | grep -q ^s3b: && ( sudo apt install nbdkit-plugin-dev make libfuse3-dev nbdkit libssl-dev nbd-client git ; test -e /usr/src/s3backer || git clone https://github.com/archiecobbs/s3backer.git /usr/src/s3backer ;cd /usr/src/s3backer ;bash rebuild.sh ; sudo make install ||true )
             echo "${MYIMG}" | grep -q ^s3b: && { nbdkit s3backer --dump-plugin|grep name=s3backer || exit 1  ; } ;
             echo "${MYIMG}" | grep -q ^s3b: && { AWSURL="$MYIMG"; mydir=$(echo "$AWSURL"|cut -d/ -f4-);myhost=$(echo "$AWSURL"|cut -d/ -f3|cut -d@ -f2); myauth=$(echo "$AWSURL"|cut -d/ -f3|cut -d@ -f1) ;sed 's/MYSIZE/${{ steps.valuesprep.outputs.size }}/g;s~s3.endpoint.lan~'"${myhost}"'~g;s~BUCKETNAME/FOLDERNAME~'"$mydir"'~g' -i configs/s3b.conf ; echo "$myauth" > /tmp/awskey ; } ;
             echo "${MYIMG}" | grep ^s3b: |grep -q "KEY=" && ((echo -- "--encrypt";  echo -- "--passwordFile=/tmp/.s3b_key") > /tmp/s3b.conf ; echo "${MYIMG}" | sed 's/.\+KEY=//g' > /tmp/.s3b.key )
             echo "${MYIMG}" | grep -q ^s3b: && { cat configs/s3b.conf >> /tmp/s3b.conf ; mkdir /tmp/s3bcache ;nbdkit --filter=exitlast --port=11111 --exportname=qemu s3backer s3b_configFile=/tmp/s3b.conf ; rm /tmp/.s3b.key || true  ; } ;
             bash -c '[[ "none" = "${{ steps.valuesprep.outputs.preloader }}" ]]   ||  ( echo using    preloader ; PRLD="${{ steps.valuesprep.outputs.preloader }}"; echo "$PRLD" |grep -q ^https:// && (wget -c -O- "$PRLD"|bash            );  echo "$PRLD" |grep -q ^s3:// && (bash s3-script-get.sh /tmp/preload "$PRLD" ; bash /tmp/preload; rm /tmp/preload|| true   ); )'
             bash -c '[[ "none" = "${{ steps.valuesprep.outputs.loader }}"    ]]   ||  ( echo using inner loader ; LOAD="${{ steps.valuesprep.outputs.loader }}";    echo "$LOAD" |grep -q ^https:// && (wget -c -O- "$LOAD" > customscrimpt );  echo "$LOAD" |grep -q ^s3:// && (bash s3-script-get.sh customscript "$LOAD" ; rm /tmp/preload|| true                      ); )'

#      - name: install action
#        id: action-install
#        run: git clone https://github.com/etchdroid/qemu-kvm-action.git
      - name: Enable KVM group perms
        run: |
          which udev||apt-get -y install udev
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      - name: Setup QEMU
#        uses: etchdroid/qemu-kvm-action/setup@main
        uses: incredinews/qemu-kvm-action/setup@main
        with:
          video-record: false
        env:
          DEBIAN_FRONTEND: noninteractive
          TERM: linux
      - name: create fifos and whatever the thingy needs
        run: |
             mkfifo /tmp/guest.in /tmp/guest.out
             #echo "cache_will_fail_if_not" > /var/cache/apt/archives/nonexisitent.deb || true 
             #sudo apt-get -y remove ovmf || true
             #apt-get -y remove ovmf || true
      - name: Run QEMU
        id: run-qemu
        uses: incredinews/qemu-kvm-action@main
#        uses: etchdroid/qemu-kvm-action@v1
        env:
          TERM: linux
        with:
#          https://github.com/etchdroid/qemu-kvm-action/blob/main/action.yml
          smp: 8
          memory: 8192
          video-record: false
          flags: |
            -serial
            pipe:/tmp/guest
            -enable-kvm
            -drive
            id=disk,file=${{ steps.setroot.outputs.root }},if=none
            -device
            ahci,id=ahci
            -device
            ide-hd,drive=disk,bus=ahci.0
            -drive
            id=cidata,file=seed.img,if=none
            -device
            ide-hd,drive=cidata,bus=ahci.1
            -k
            ${{ steps.valuesprep.outputs.keymap }}
            -net
            nic,model=rtl8139
            -net
            user,hostfwd=tcp::2222-:22,hostfwd=tcp::15901-:5901
            -vnc
            :1
            -device
            VGA,vgamem_mb=${{ steps.valuesprep.outputs.vgamem }}
            -drive
            ${{ steps.valuesprep.outputs.cdrom }}
            -boot
            ${{ steps.valuesprep.outputs.bootorder }}
#         run: test -e ~/.ssh|mkdir ~/.ssh;echo "${{ steps.valuesprep.outputs.sshkey }}" > .ssh/authorized_keys;echo provisioning from ${{ steps.valuesprep.outputs.myip }} ; echo ${{ steps.valuesprep.outputs.myip }} > /tmp/myip ;sleep 10 ;( tail -f --retry  /tmp/guest.out || tail -f  /tmp/guest.out ) &  test -e TMP_SCRIPT && bash TMP_SCRIPT || true ;  docker ps -a ;echo  > /tmp/guest.in  ;sleep 42 ; ( echo timmy;sleep 1;echo password111 ;sleep 5;echo 'doas ash -c "echo asd;test -e /dev/ttyS0 && echo in_term_ttyS0 >>/dev/ttyS0 ; test -e /dev/ttyAMA0 && echo in_term_ttyAMA0 >> /dev/ttyAMA0; ln -s /tmp/tsocks.conf /etc/; apk add tor tsocks screen curl socat bash"';sleep 1 ; echo password ;sleep 1;echo bash;sleep 1;cat serialscript;sleep 3) > /tmp/guest.in & sleep 20;bash -c "ps -ALFc|grep qemu;ps w|grep qemu;sleep 60; while (ps -ALFc|grep -v grep |grep qemu|grep  kvm |grep 8192);do sleep 60 ;echo -n .;done"
          run: test -e ~/.ssh|mkdir ~/.ssh;echo "${{ steps.valuesprep.outputs.sshkey }}" > .ssh/authorized_keys;echo provisioning from ${{ steps.valuesprep.outputs.myip }} ; echo ${{ steps.valuesprep.outputs.myip }} > /tmp/myip ;sleep 10 ;( tail -f --retry  /tmp/guest.out || tail -f  /tmp/guest.out ) &  test -e TMP_SCRIPT && bash TMP_SCRIPT || true ;  docker ps -a ;echo  > /tmp/guest.in  ;sleep 42 ; ( echo ) > /tmp/guest.in & sleep 20;bash -c "ps -ALFc|grep qemu;ps w|grep qemu;sleep 60;counter="0"; while ((echo |nc 127.0.0.1 2222)|grep -i ssh -q|| exit 1);do  counter=$(($counter + 1 ));[[ $(($counter % 10 )) -eq 0 ]] && echo ; sleep 60 ;echo -n .;done"

# echo 'screen -dmS sshj ash -c "while (true);do ssh qemukvmtest@ssh-j.com -N -R qemukvm:22:localhost:22 ;done" & '          
#            -smbios
#            type=1,serial=ds='nocloud;s=http://10.0.2.2:8000/'

            #  -monitor
          #  pipe:/tmp/guest
#            type=1,serial=ds='nocloud;s=http://${{ steps.prepareqemu.outputs.myip }}:8000/'
          #run: cat /tmp/guest.out & sleep 60 ;(echo sendkey r ;echo sendkey o ;echo sendkey o ;echo sendkey t;echo sendkey ret ;echo sendkey r ;echo sendkey o ;echo sendkey o ;echo sendkey t;echo sendkey ret ; echo sendkey t;echo sendkey o ;echo sendkey p;echo sendkey ret;sleep 2 ) > /tmp/guest.in; sleep 20

      - name: Upload video
        uses: actions/upload-artifact@v4
        with:
          name: recording
          path: ${{ steps.run-qemu.outputs.video-output }}
