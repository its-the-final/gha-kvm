on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:

  test:
    runs-on: ubuntu-latest
#    container: ghcr.io/its-the-final/gha-kvm:latest
    steps:
      - uses: actions/checkout@v4

#      - uses: ilammy/setup-nasm@v1

      - name: Cache Primes
        id: cache-primes
        uses: actions/cache@v4
        with:
          path: alpine-x86_64.qcow2
          key: ${{ runner.os }}-primes
  
      - name: Prepare Boot-Man demo
        if: steps.cache-primes.outputs.cache-hit != 'true'
        run: |
          #git clone https://github.com/guyhill/Boot-Man
          #cd Boot-Man
          #make
          bash -c "time wget -q -c -O alpine-x86_64.qcow2 https://dl-cdn.alpinelinux.org/alpine/v3.22/releases/cloud/nocloud_alpine-3.22.1-x86_64-bios-cloudinit-r0.qcow2"
          #wget -q -c https://cloud.debian.org/images/cloud/bullseye-backports/20250703-2162/debian-11-backports-nocloud-amd64-20250703-2162.tar.xz
          #tar --xz -xf debian-11-backports-nocloud-amd64-20250703-2162.tar.xz
          #ln -s debian-11-backports-nocloud-amd64-20250703-2162.raw alpine-x86_64.img
          #which qemu-img|| sudo apt-get update && sudo apt-get -y install qemu-utils;  
          bash -c "time  qemu-img resize alpine-x86_64.qcow2 +32G"

      #- name: PREPARE qemu
      #  id: prepareqemu
      #  run: bash prepare-cloudinit.sh ; which curl || apt-get -y --no-install-recommends curl;which python3 || apt-get -y --no-install-recommends python3 ;cd cinit;pwd;python3 -m http.server --directory . &  sleep 2;curl 127.0.0.1:8000;echo;echo;ipconfig="myip="$(ip a|grep eth0|grep inet|grep -v inet6|cut -dt -f2|cut -d/ -f1|head -n1|cut -d" " -f2);echo $ipconfig;echo $ipconfig >> $GITHUB_OUTPUT
#      - name: install action
#        id: action-install
#        run: git clone https://github.com/etchdroid/qemu-kvm-action.git
      - name: Setup QEMU
        uses: etchdroid/qemu-kvm-action/setup@v1
        with:
          video-record: true
        env:
          DEBIAN_FRONTEND: noninteractive
          TERM: linux
      - name: create fifos
        run:  mkfifo /tmp/guest.in /tmp/guest.out
      - name: Run QEMU
        id: run-qemu
        uses: etchdroid/qemu-kvm-action@v1
        with:
          video-record: true
          #flags: 'Boot-Man/boot-man.bin'
          flags: |
            -serial
            pipe:/tmp/guest
            -enable-kvm
            -drive
            id=disk,file=alpine-x86_64.qcow2,if=none
            -device
            ahci,id=ahci
            -device
            ide-hd,drive=disk,bus=ahci.0
            -drive
            id=cidata,file=seed.img,if=none
            -device
            ide-hd,drive=cidata,bus=ahci.1

          run: echo provisioning from ${{ steps.prepareqemu.outputs.myip }} ;cat /tmp/guest.out & sleep 60 ; ( echo timmy;sleep 1;echo password ;sleep 5;echo 'doas ash -c "echo asd;test -e /dev/ttyS0 && echo ttyS0 >>/dev/ttyS0 ; test -e /dev/ttyAMA0 && echo ttyAMA0 >> /dev/ttyAMA0; apk add tsocks screen curl socat bash;echo IyBUaGlzIGlzIHRoZSBjb25maWd1cmF0aW9uIGZvciBsaWJ0c29ja3MgKHRyYW5zcGFyZW50IHNvY2tzKQojIExpbmVzIGJlZ2lubmluZyB3aXRoICMgYW5kIGJsYW5rIGxpbmVzIGFyZSBpZ25vcmVkCiMKIyBUaGUgYmFzaWMgaWRlYSBpcyB0byBzcGVjaWZ5OgojCS0gTG9jYWwgc3VibmV0cyAtIE5ldHdvcmtzIHRoYXQgY2FuIGJlIGFjY2Vzc2VkIGRpcmVjdGx5IHdpdGhvdXQKIwkJCSAgYXNzaXN0YW5jZSBmcm9tIGEgc29ja3Mgc2VydmVyCiMJLSBQYXRocyAtIFBhdGhzIGFyZSBiYXNpY2FsbHkgbGlzdHMgb2YgbmV0d29ya3MgYW5kIGEgc29ja3Mgc2VydmVyCiMJCSAgd2hpY2ggY2FuIGJlIHVzZWQgdG8gcmVhY2ggdGhlc2UgbmV0d29ya3MKIwktIERlZmF1bHQgc2VydmVyIC0gQSBzb2NrcyBzZXJ2ZXIgd2hpY2ggc2hvdWxkIGJlIHVzZWQgdG8gYWNjZXNzIAojCQkJICAgbmV0d29ya3MgZm9yIHdoaWNoIG5vIHBhdGggaXMgYXZhaWxhYmxlCiMgTXVjaCBtb3JlIGRvY3VtZW50YXRpb24gdGhhbiBwcm92aWRlZCBpbiB0aGVzZSBjb21tZW50cyBjYW4gYmUgZm91bmQgaW4KIyB0aGUgbWFuIHBhZ2VzLCB0c29ja3MoOCkgYW5kIHRzb2Nrcy5jb25mKDgpCgojIExvY2FsIG5ldHdvcmtzCiMgRm9yIHRoaXMgZXhhbXBsZSB0aGlzIG1hY2hpbmUgY2FuIGRpcmVjdGx5IGFjY2VzcyAxOTIuMTY4LjAuMC8yNTUuMjU1LjI1NS4wIAojICgxOTIuMTY4LjAuKikgYW5kIDEwLjAuMC4wLzI1NS4wLjAuMCAoMTAuKikKCmxvY2FsID0gMTkyLjE2OC4yNi4wLzI1NS4yNTUuMjU1LjAKbG9jYWwgPSAxMC4wLjAuMC8yNTUuMC4wLjAKbG9jYWwgPSAxMjcuMC4wLjEvMjU1LjI1NS4yNTUuMjU1CgojIFBhdGhzCiMgRm9yIHRoaXMgZXhhbXBsZSB0aGlzIG1hY2hpbmUgbmVlZHMgdG8gYWNjZXNzIDE1MC4wLjAuMC8yNTUuMjU1LjAuMCBhcyAKIyB3ZWxsIGFzIHBvcnQgODAgb24gdGhlIG5ldHdvcmsgMTUwLjEuMC4wLzI1NS4yNTUuMC4wIHRocm91Z2gKIyB0aGUgc29ja3MgNSBzZXJ2ZXIgYXQgMTAuMS43LjI1IChpZiB0aGlzIG1hY2hpbmVzIGhvc3RuYW1lIHdhcyAKIyAic29ja3MuaGVsbG8uY29tIiB3ZSBjb3VsZCBhbHNvIHNwZWNpZnkgdGhhdCwgdW5sZXNzIC0tZGlzYWJsZS1ob3N0bmFtZXMKIyB3YXMgc3BlY2lmaWVkIHRvIC4vY29uZmlndXJlKS4KCnBhdGggewoJcmVhY2hlcyA9IDE5Mi4xNjguMC4wLzI1NS4yNTUuMC4wCglyZWFjaGVzID0gMTAuMC4wLjAvMjU1LjAuMC4wCiMJcmVhY2hlcyA9IDAuMC4wLjA6NDQzLzAuMC4wLjAKIwlyZWFjaGVzID0gMC4wLjAuMDo0NDMvMC4wLjAuMAoJc2VydmVyID0gMTAuMS43LjI1CglzZXJ2ZXJfdHlwZSA9IDUKCWRlZmF1bHRfdXNlciA9IGRlbGl1cwoJZGVmYXVsdF9wYXNzID0gaGVsbG8KfQoKIyBEZWZhdWx0IHNlcnZlcgojIEZvciBjb25uZWN0aW9ucyB0aGF0IGFyZW4ndCB0byB0aGUgbG9jYWwgc3VibmV0cyBvciB0byAxNTAuMC4wLjAvMjU1LjI1NS4wLjAKIyB0aGUgc2VydmVyIGF0IDE5Mi4xNjguMC4xIHNob3VsZCBiZSB1c2VkIChhZ2FpbiwgaG9zdG5hbWVzIGNvdWxkIGJlIHVzZWQKIyB0b28sIHNlZSBub3RlIGFib3ZlKQoKc2VydmVyID0gMTI3LjAuMC4xCiMgU2VydmVyIHR5cGUgZGVmYXVsdHMgdG8gNCBzbyB3ZSBuZWVkIHRvIHNwZWNpZnkgaXQgYXMgNSBmb3IgdGhpcyBvbmUKc2VydmVyX3R5cGUgPSA0CiMgVGhlIHBvcnQgZGVmYXVsdHMgdG8gMTA4MCBidXQgSSd2ZSBzdGF0ZWQgaXQgaGVyZSBmb3IgY2xhcml0eSAKc2VydmVyX3BvcnQgPSA5MDUwCgo=|base64 -d  > /etc/tsocks.conf"';sleep 1;echo password ;sleep 15;echo uptime;echo nproc;echo id -u ; echo ifconfig ;echo df -h ;echo 'ssh-keyscan ssh-j.com >> ~/.ssh/known_hosts;ssh-keyscan ssh.optimistixtunnel.com >> ~/.ssh/known_hosts;' ;echo 'while(true);do date; tsocks ssh qtstusr1234@ssh-j.com -N -R qtstusr1234:22:localhost:22 ;sleep 1;done';echo "socat tcp-listen:443,fork,reuseaddr tcp-connect:127.0.0.1:22 &" ;echo  "ssh -o 'StrictHostKeyChecking no' -p 1122 -R 443:localhost:3000 ssh.optimistixtunnel.com" ;sleep 3) > /tmp/guest.in & sleep 600
# echo 'screen -dmS sshj ash -c "while (true);do ssh qemukvmtest@ssh-j.com -N -R qemukvm:22:localhost:22 ;done" & '          
#            -smbios
#            type=1,serial=ds='nocloud;s=http://10.0.2.2:8000/'

            #  -monitor
          #  pipe:/tmp/guest
#            type=1,serial=ds='nocloud;s=http://${{ steps.prepareqemu.outputs.myip }}:8000/'
          #run: cat /tmp/guest.out & sleep 60 ;(echo sendkey r ;echo sendkey o ;echo sendkey o ;echo sendkey t;echo sendkey ret ;echo sendkey r ;echo sendkey o ;echo sendkey o ;echo sendkey t;echo sendkey ret ; echo sendkey t;echo sendkey o ;echo sendkey p;echo sendkey ret;sleep 2 ) > /tmp/guest.in; sleep 20

      - name: Upload video
        uses: actions/upload-artifact@v4
        with:
          name: recording
          path: ${{ steps.run-qemu.outputs.video-output }}
